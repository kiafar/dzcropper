/*!
 * dzCropper.js v1.0
 * https://github.com/kiafar/dzcropper
 *
 * Copyright (c) 2018 Tirdad Kiafar
 * Released under the MIT license
 *
 * 05/07/2018 @ 5:38pm (UTC)
 */
!function(e,a){"function"==typeof define&&define.amd?define(["jquery"],a):"object"==typeof module&&module.exports?module.exports=function(t,o){return void 0===o&&(o=void 0!==e?require("jquery"):require("jquery")(t)),a(o),o}:a(jQuery)}(this,function(e){"use strict";var a=[],t={},o={maxDimention:900,maxFiles:2,maxFilesize:2,acceptedFiles:"image/*",clickable:[".dropzone"],mainTemplate:'<form title="Drop images to upload, or click to browse" action="upload.php" class="dropzone" id="my-dropzone-container" method="post" enctype="multipart/form-data"><img src="img/upload.png" alt="upload" class="dz-upload-img"/><div class="fallback"><input name="file" type="file"></div></form>',modalTemplate:'<div class="modal fade" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title">Crop</h4></div><div class="modal-body"><div class="image-container">\x3c!-- image goest here --\x3e</div></div><div class="modal-footer"><button type="button" class="btn btn-warning rotate-left" title="Rotate counterclockwise"><span class="fa fa-rotate-left"></span></button><button type="button" class="btn btn-warning rotate-right" title="Rotate clockwise"><span class="fa fa-rotate-right"></span></button><button type="button" class="btn btn-warning scale-x" data-value="-1" title="Flip horizontally"><span class="fa fa-arrows-h"></span></button><button type="button" class="btn btn-warning scale-y" data-value="-1" title="Flip vertically"><span class="fa fa-arrows-v"></span></button><button type="button" class="btn btn-warning reset" title="Reset to default"><span class="fa fa-refresh"></span></button><button type="button" class="btn btn-default" data-dismiss="modal" title="Close window">Cancel</button><button type="button" class="btn btn-primary crop-upload" title="Save">Done</button></div></div></div></div>',onDropzoneReady:function(){},onCropperReady:function(){}};function i(){e(".modal-backdrop").last().addClass("last"),e(".modal").last().addClass("last")}e.fn.dzCropper=function(l){(t=Object.assign({},o,void 0!==l&&l)).clickable.push(".dz-upload-img");var r=e(this),s=0,d=e(t.mainTemplate);Dropzone.autoDiscover=!1,r.append(d);var c=new Dropzone(d[0],{clickable:Array.isArray(t.clickable)&&t.clickable,autoQueue:!1,autoProcessQueue:!1,addRemoveLinks:!0,maxFilesize:t.maxFilesize,maxFiles:t.maxFiles,acceptedFiles:t.acceptedFiles,dictDefaultMessage:"Drop images here, or click to browse",dictRemoveFile:"Remove",init:function(){"function"==typeof t.onDropzoneReady&&t.onDropzoneReady(r.data("dropzone"))}});r.data("dropzone",c),c.on("addedfile",function(o){!function(o){if(o.cropped)return;if(function(e){var o=[];for(let e=0;e<c.files.length;e++){var i=c.files[e];i.cropped&&o.push(i)}if(Number.isInteger(t.maxFiles)&&o.length<t.maxFiles)return!1;for(let t=0;t<a.length;t++)if((i=a[t]).name===e.name&&i.size===e.size)return!1;return!0}(o.originalFile||o))return c.removeFile(o),void alert("You cannot add more than "+t.maxFiles+" files.");c.removeFile(o);var l=new FileReader;l.onloadend=function(){var d=new Image;d.src=l.result,d.onload=function(){var l=this.width,p=this.height;if(o.originalFile=o.originalFile?o.originalFile:{name:o.name,size:o.size,lastModified:o.lastModified},l<=t.maxDimention||p<=t.maxDimention)!function(o,l){o.id="img-"+ ++s;var d=e(t.modalTemplate);d.find(".image-container").append(o),d.modal({backdrop:"static",keyboard:!0}).on("shown.bs.modal",function(){i();var s=new Cropper(o,{aspectRatio:1,autoCropArea:1,movable:!1,cropBoxResizable:!0,rotatable:!0,ready:function(){"function"==typeof t.onCropperReady&&t.onCropperReady(r.data("cropper"))}});r.data("cropper",s);var d=e(this);d.on("click",".crop-upload",function(){var e=s.getCroppedCanvas({fillColor:"#fff"}).toDataURL("image/jpeg",.9),o=n(e);o.name=l.name,o.cropped=!0;for(var i=c.getAcceptedFiles(),r=0;r<i.length;r++){var p=i[r];p.name===l.name&&c.removeFile(p)}c.addFile(o),o.size<=1024*t.maxFilesize*1024&&(c.enqueueFile(o),c.processQueue()),a.push(l.originalFile),d.modal("hide")}).on("hidden.bs.modal",function(e){i()}).on("click",".rotate-right",function(){s.rotate(90)}).on("click",".rotate-left",function(){s.rotate(-90)}).on("click",".reset",function(){s.reset()}).on("click",".scale-x",function(){var a=e(this);s.scaleX(a.data("value")),a.data("value",-a.data("value"))}).on("click",".scale-y",function(){var a=e(this);s.scaleY(a.data("value")),a.data("value",-a.data("value"))})})}(d,o);else{l>p?(l*=t.maxDimention/p,p=t.maxDimention):(p*=t.maxDimention/l,l=t.maxDimention);var u=document.createElement("canvas");u.width=l,u.height=p;var m=u.getContext("2d");m.fillStyle="white",m.drawImage(d,0,0,l,p);var f=function(a,t){var o,i;o=-1!==a.split(",")[0].indexOf("base64")?atob(a.split(",")[1]):decodeURI(a.split(",")[1]);i=a.split(",")[0].split(":")[1].split(";")[0];for(var n=new Array,l=0;l<o.length;l++)n[l]=o.charCodeAt(l);var r=new File([new Uint8Array(n)],t.name,{type:i});return e.each(["upload","status","previewElement","previewTemplate","accepted"],function(e,a){r[a]=t[a]}),r}(u.toDataURL(),o);f.originalFile=o.originalFile,c.addFile(f)}}},l.readAsDataURL(o)}(o)})};var n=function(e){for(var a=atob(e.split(",")[1]),t=new ArrayBuffer(a.length),o=new Uint8Array(t),i=0;i<a.length;i++)o[i]=a.charCodeAt(i);return new Blob([t],{type:"image/jpeg"})}});